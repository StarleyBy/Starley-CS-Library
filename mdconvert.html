<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD to Metadata Converter</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 2rem;
        }

        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            background: #f8f9ff;
        }

        .upload-zone:hover {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: scale(1.02);
        }

        .upload-zone.dragover {
            background: #e8ebff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .upload-zone input[type="file"] {
            display: none;
        }

        .settings {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        button {
            flex: 1;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .preview {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 12px;
            display: none;
        }

        .preview.active {
            display: block;
        }

        .preview h3 {
            margin-bottom: 1rem;
            color: #667eea;
        }

        .preview-content {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: none;
        }

        .alert.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert.active {
            display: block;
        }

        .processing {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .processing.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìö MD to Metadata Converter</h1>
            <p>–ü—Ä–µ–æ–±—Ä–∞–∑—É–π—Ç–µ Markdown –≥–ª–∞–≤—É –≤ metadata.json</p>
        </div>

        <div class="content">
            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <h3>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ MD —Ñ–∞–π–ª —Å—é–¥–∞</h3>
                <p>–∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                <input type="file" id="fileInput" accept=".md,.markdown">
            </div>

            <!-- Settings -->
            <div class="settings">
                <div class="form-group">
                    <label for="chapterNumber">–ù–æ–º–µ—Ä –≥–ª–∞–≤—ã:</label>
                    <input type="number" id="chapterNumber" value="1" min="1" max="20">
                </div>

                <div class="form-group">
                    <label for="chapterTitle">–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                    <input type="text" id="chapterTitle" placeholder="–ë—É–¥–µ—Ç –∏–∑–≤–ª–µ—á–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ MD">
                </div>
            </div>

            <!-- Processing Indicator -->
            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p>–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞...</p>
            </div>

            <!-- Alert -->
            <div class="alert" id="alert"></div>

            <!-- Buttons -->
            <div class="buttons">
                <button class="btn-primary" id="convertBtn" disabled>
                    üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button class="btn-secondary" id="downloadBtn" disabled>
                    üíæ –°–∫–∞—á–∞—Ç—å JSON
                </button>
            </div>

            <!-- Preview -->
            <div class="preview" id="preview">
                <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</h3>
                <div class="stats" id="stats"></div>
                
                <h3 style="margin-top: 2rem;">üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä metadata.json:</h3>
                <div class="preview-content" id="previewContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let generatedMetadata = null;

        // Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const chapterNumber = document.getElementById('chapterNumber');
        const chapterTitle = document.getElementById('chapterTitle');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const preview = document.getElementById('preview');
        const previewContent = document.getElementById('previewContent');
        const stats = document.getElementById('stats');
        const alert = document.getElementById('alert');
        const processing = document.getElementById('processing');

        // Upload zone click
        uploadZone.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // Handle file
        function handleFile(file) {
            if (!file.name.endsWith('.md') && !file.name.endsWith('.markdown')) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ MD —Ñ–∞–π–ª', 'error');
                return;
            }

            currentFile = file;
            uploadZone.querySelector('h3').textContent = `‚úÖ ${file.name}`;
            convertBtn.disabled = false;
            showAlert(`–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${file.name}`, 'success');
        }

        // Convert button
        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            processing.classList.add('active');
            convertBtn.disabled = true;

            try {
                const content = await currentFile.text();
                const metadata = extractMetadata(content, parseInt(chapterNumber.value));
                
                generatedMetadata = metadata;
                displayPreview(metadata);
                downloadBtn.disabled = false;
                
                processing.classList.remove('active');
                showAlert('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
            } catch (error) {
                processing.classList.remove('active');
                showAlert('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
                console.error(error);
            }
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (!generatedMetadata) return;

            const json = JSON.stringify(generatedMetadata, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chapter-${chapterNumber.value.padStart(2, '0')}-metadata.json`;
            a.click();
            URL.revokeObjectURL(url);

            showAlert('üì• –§–∞–π–ª —Å–∫–∞—á–∞–Ω!', 'success');
        });

        // Extract metadata from markdown
        function extractMetadata(content, chapNum) {
            // Extract chapter title
            let title = chapterTitle.value;
            if (!title) {
                const titleMatch = content.match(/^#\s+(.+)$/m);
                if (titleMatch) {
                    title = titleMatch[1]
                        .replace(/^\*\*CHAPTER\s+\d+\*\*\s*/i, '')
                        .replace(/^CHAPTER\s+\d+\s*/i, '')
                        .trim();
                } else {
                    title = `Chapter ${chapNum}`;
                }
            }

            const metadata = {
                chapter_id: `chapter-${chapNum.toString().padStart(2, '0')}`,
                chapter_number: chapNum,
                title: title,
                sections: extractSections(content),
                figures: extractFigures(content),
                tables: extractTables(content),
                key_terms: extractKeyTerms(content)
            };

            return metadata;
        }

        // Extract sections
        function extractSections(content) {
            const sections = [];
            const lines = content.split('\n');
            let currentH2 = null;

            lines.forEach(line => {
                // H2 headers
                const h2Match = line.match(/^##\s+(.+)$/);
                if (h2Match) {
                    const title = h2Match[1].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                    const id = createAnchorId(title);
                    
                    const section = {
                        id: id,
                        title: title,
                        level: 2,
                        anchor: id,
                        subsections: []
                    };
                    
                    sections.push(section);
                    currentH2 = section;
                }

                // H3 headers
                const h3Match = line.match(/^###\s+(.+)$/);
                if (h3Match && currentH2) {
                    const title = h3Match[1].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                    const id = createAnchorId(title);
                    
                    const subsection = {
                        id: id,
                        title: title,
                        level: 3,
                        anchor: id,
                        parent: currentH2.id
                    };
                    
                    currentH2.subsections.push(subsection);
                }
            });

            return sections;
        }

        // Extract figures
        function extractFigures(content) {
            const figures = [];
            const pattern = /!\[([^\]]*)\]\(([^)]+)\)/g;
            let match;
            let figureNumber = 1;

            while ((match = pattern.exec(content)) !== null) {
                const altText = match[1].trim();
                const imagePath = match[2].trim();

                if (!imagePath || imagePath.startsWith('http')) continue;

                const pageMatch = imagePath.match(/_page_(\d+)_/);
                const figureId = `figure-${figureNumber}`;

                // Try to find caption
                const contextStart = match.index + match[0].length;
                const context = content.substring(contextStart, contextStart + 500);
                const captionMatch = context.match(/\*?\*?Figure\s+[\d.]+\s*[‚Ä¢¬∑]?\s*(.+?)(?:\n\n|\n\*\*|\Z)/s);
                const caption = captionMatch ? captionMatch[1].replace(/\*\*(.+?)\*\*/g, '$1').replace(/\n/g, ' ').trim() : altText || `Figure ${figureNumber}`;

                const figure = {
                    id: figureId,
                    number: figureNumber.toString(),
                    file: `images/${imagePath.split('/').pop()}`,
                    caption: caption,
                    alt: altText || `Medical illustration ${figureNumber}`,
                    anchor: figureId
                };

                if (pageMatch) {
                    figure.original_page = parseInt(pageMatch[1]);
                }

                figures.push(figure);
                figureNumber++;
            }

            return figures;
        }

        // Extract tables
        function extractTables(content) {
            const tables = [];
            const pattern = /(?:^|\n)(?:#+\s+)?(?:\*\*)?Table\s+([\d.]+)\s*[‚Ä¢¬∑]\s*(.+?)(?:\*\*)?(?=\n|$)/gm;
            let match;

            while ((match = pattern.exec(content)) !== null) {
                const tableNumber = match[1];
                const tableTitle = match[2].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                const tableId = `table-${tableNumber.replace(/\./g, '-')}`;

                tables.push({
                    id: tableId,
                    number: tableNumber,
                    title: tableTitle,
                    anchor: tableId
                });
            }

            return tables;
        }

        // Extract key terms
        function extractKeyTerms(content) {
            const terms = new Set();
            const pattern = /<span class="medical-term">(.+?)<\/span>/g;
            let match;

            while ((match = pattern.exec(content)) !== null) {
                terms.add(match[1].trim());
            }

            return Array.from(terms).sort();
        }

        // Create anchor ID
        function createAnchorId(title) {
            return title
                .replace(/^[IVX]+\.\s+/g, '')
                .replace(/^[A-Z]\.\s+/g, '')
                .replace(/^\d+\.\s+/g, '')
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // Display preview
        function displayPreview(metadata) {
            // Stats
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${metadata.sections.length}</div>
                    <div class="stat-label">–†–∞–∑–¥–µ–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.figures.length}</div>
                    <div class="stat-label">–†–∏—Å—É–Ω–∫–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.tables.length}</div>
                    <div class="stat-label">–¢–∞–±–ª–∏—Ü</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.key_terms.length}</div>
                    <div class="stat-label">–¢–µ—Ä–º–∏–Ω–æ–≤</div>
                </div>
            `;

            // JSON preview
            previewContent.textContent = JSON.stringify(metadata, null, 2);

            preview.classList.add('active');
        }

        // Show alert
        function showAlert(message, type) {
            alert.textContent = message;
            alert.className = `alert ${type} active`;
            
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }
    </script>
</body>
</html>
