<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MD to Metadata Converter</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .container {
            max-width: 900px;
            margin: 2rem auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .content {
            padding: 2rem;
        }
    </style>
</head>
<body>
    <header>
        <h1>üìö Medical library</h1>
        <nav>
            <a href="index.html">Library</a>
            <a href="editor.html">Editor</a>
            <a href="mdconvert.html">MD convert</a>
        </nav>
    </header>
    <div class="container">
        <div class="header" style="background: #667eea;">
            <h1>MD to Metadata Converter</h1>
            <p>Convert a Markdown chapter into metadata.json</p>
        </div>

        <div class="content">
            <!-- Upload Zone -->
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <h3>Drag & Drop MD file here</h3>
                <p>or click to select a file</p>
                <input type="file" id="fileInput" accept=".md,.markdown">
            </div>

            <!-- Settings -->
            <div class="settings">
                <div class="form-group">
                    <label for="chapterNumber">Chapter Number:</label>
                    <input type="number" id="chapterNumber" value="1" min="1" max="20">
                </div>

                <div class="form-group">
                    <label for="chapterTitle">Chapter Title (optional):</label>
                    <input type="text" id="chapterTitle" placeholder="Will be extracted automatically from MD">
                </div>
            </div>

            <!-- Processing Indicator -->
            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p>Processing file...</p>
            </div>

            <!-- Alert -->
            <div class="alert" id="alert"></div>

            <!-- Buttons -->
            <div class="buttons">
                <button class="btn-primary" id="convertBtn" disabled>
                    üîÑ Convert
                </button>
                <button class="btn-secondary" id="downloadBtn" disabled>
                    üíæ Download JSON
                </button>
            </div>

            <!-- Preview -->
            <div class="preview" id="preview">
                <h3>üìä Statistics:</h3>
                <div class="stats" id="stats"></div>
                
                <h3 style="margin-top: 2rem;">üëÅÔ∏è Preview metadata.json:</h3>
                <div class="preview-content" id="previewContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let generatedMetadata = null;

        // Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const chapterNumber = document.getElementById('chapterNumber');
        const chapterTitle = document.getElementById('chapterTitle');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const preview = document.getElementById('preview');
        const previewContent = document.getElementById('previewContent');
        const stats = document.getElementById('stats');
        const alert = document.getElementById('alert');
        const processing = document.getElementById('processing');

        // Upload zone click
        uploadZone.addEventListener('click', () => fileInput.click());

        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // Drag and drop
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        // Handle file
        function handleFile(file) {
            if (!file.name.endsWith('.md') && !file.name.endsWith('.markdown')) {
                showAlert('Please select a .md file', 'error');
                return;
            }

            currentFile = file;
            uploadZone.querySelector('h3').textContent = `‚úÖ ${file.name}`;
            convertBtn.disabled = false;
            showAlert(`File loaded: ${file.name}`, 'success');
        }

        // Convert button
        convertBtn.addEventListener('click', async () => {
            if (!currentFile) return;

            processing.classList.add('active');
            convertBtn.disabled = true;

            try {
                const content = await currentFile.text();
                const metadata = extractMetadata(content, parseInt(chapterNumber.value));
                
                generatedMetadata = metadata;
                displayPreview(metadata);
                downloadBtn.disabled = false;
                
                processing.classList.remove('active');
                showAlert('‚úÖ Conversion completed successfully!', 'success');
            } catch (error) {
                processing.classList.remove('active');
                showAlert('‚ùå Error: ' + error.message, 'error');
                console.error(error);
            }
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (!generatedMetadata) return;

            const json = JSON.stringify(generatedMetadata, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chapter-${String(chapterNumber.value).padStart(2, '0')}-metadata.json`;
            a.click();
            URL.revokeObjectURL(url);

            showAlert('üì• File downloaded!', 'success');
        });

        // Extract metadata from markdown
        function extractMetadata(content, chapNum) {
            // Extract chapter title
            let title = chapterTitle.value;
            if (!title) {
                const titleMatch = content.match(/^#\s+(.+)$/m);
                if (titleMatch) {
                    title = titleMatch[1]
                        .replace(/^\*\*CHAPTER\s+\d+\*\*\s*/i, '')
                        .replace(/^CHAPTER\s+\d+\s*/i, '')
                        .trim();
                } else {
                    title = `Chapter ${chapNum}`;
                }
            }

            const metadata = {
                chapter_id: `chapter-${String(chapNum).padStart(2, '0')}`,
                chapter_number: chapNum,
                title: title,
                sections: extractSections(content),
                figures: extractFigures(content),
                tables: extractTables(content),
                key_terms: extractKeyTerms(content)
            };

            return metadata;
        }

        // Extract sections
        function extractSections(content) {
            const sections = [];
            const lines = content.split('\n');
            let currentH2 = null;

            lines.forEach(line => {
                // H2 headers
                const h2Match = line.match(/^##\s+(.+)$/);
                if (h2Match) {
                    const title = h2Match[1].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                    const id = createAnchorId(title);
                    
                    const section = {
                        id: id,
                        title: title,
                        level: 2,
                        anchor: id,
                        subsections: []
                    };
                    
                    sections.push(section);
                    currentH2 = section;
                }

                // H3 headers
                const h3Match = line.match(/^###\s+(.+)$/);
                if (h3Match && currentH2) {
                    const title = h3Match[1].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                    const id = createAnchorId(title);
                    
                    const subsection = {
                        id: id,
                        title: title,
                        level: 3,
                        anchor: id,
                        parent: currentH2.id
                    };
                    
                    currentH2.subsections.push(subsection);
                }
            });

            return sections;
        }

        // Extract figures
        function extractFigures(content) {
            const figures = [];
            const pattern = /!\[([^\]]*)\]\(([^)]+)\)/g;
            let match;
            let figureNumber = 1;

            while ((match = pattern.exec(content)) !== null) {
                const altText = match[1].trim();
                const imagePath = match[2].trim();

                if (!imagePath || imagePath.startsWith('http')) continue;

                const pageMatch = imagePath.match(/_page_(\d+)_/);
                const figureId = `figure-${figureNumber}`;

                // Try to find caption
                const contextStart = match.index + match[0].length;
                const context = content.substring(contextStart, contextStart + 500);
                const captionMatch = context.match(/\*?\*?Figure\s+[\d.]+\s*[‚Ä¢¬∑]?\s*(.+?)(?:\n\n|\n\*\*|\Z)/s);
                const caption = captionMatch ? captionMatch[1].replace(/\*\*(.+?)\*\*/g, '$1').replace(/\n/g, ' ').trim() : altText || `Figure ${figureNumber}`;

                const figure = {
                    id: figureId,
                    number: String(figureNumber),
                    file: `images/${imagePath.split('/').pop()}`,
                    caption: caption,
                    alt: altText || `Medical illustration ${figureNumber}`,
                    anchor: figureId
                };

                if (pageMatch) {
                    figure.original_page = parseInt(pageMatch[1]);
                }

                figures.push(figure);
                figureNumber++;
            }

            return figures;
        }

        // Extract tables
        function extractTables(content) {
            const tables = [];
            const pattern = /(?:^|\n)(?:#+\s+)?(?:\*\*)?Table\s+([\d.]+)\s*[‚Ä¢¬∑]\s*(.+?)(?:\*\*)?(?=\n|$)/gm;
            let match;

            while ((match = pattern.exec(content)) !== null) {
                const tableNumber = match[1];
                const tableTitle = match[2].replace(/\*\*(.+?)\*\*/g, '$1').trim();
                const tableId = `table-${tableNumber.replace(/\./g, '-')}`;

                tables.push({
                    id: tableId,
                    number: tableNumber,
                    title: tableTitle,
                    anchor: tableId
                });
            }

            return tables;
        }

        // Extract key terms
        function extractKeyTerms(content) {
            const terms = new Set();
            const pattern = /<span class="medical-term">(.+?)<\/span>/g;
            let match;

            while ((match = pattern.exec(content)) !== null) {
                terms.add(match[1].trim());
            }

            return Array.from(terms).sort();
        }

        // Create anchor ID
        function createAnchorId(title) {
            return title
                .replace(/^[IVX]+\.\s+/g, '')
                .replace(/^[A-Z]\.\s+/g, '')
                .replace(/^\d+\.\s+/g, '')
                .toLowerCase()
                .replace(/[^\w\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // Display preview
        function displayPreview(metadata) {
            // Stats
            stats.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${metadata.sections.length}</div>
                    <div class="stat-label">Sections</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.figures.length}</div>
                    <div class="stat-label">Figures</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.tables.length}</div>
                    <div class="stat-label">Tables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${metadata.key_terms.length}</div>
                    <div class="stat-label">Key Terms</div>
                </div>
            `;

            // JSON preview
            previewContent.textContent = JSON.stringify(metadata, null, 2);

            preview.classList.add('active');
        }

        // Show alert
        function showAlert(message, type) {
            alert.textContent = message;
            alert.className = `alert ${type} active`;
            
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }
    </script>
</body>
</html>
